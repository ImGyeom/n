<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secure Webhook Manager | DeepSeek Style</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
  <style>
    :root {
      --color-primary: #3e8ef7;
      --color-primary-dark: #2c7be5;
      --color-bg: #0f172a;
      --color-surface: #1e293b;
      --color-text: #e2e8f0;
      --color-text-secondary: #94a3b8;
      --color-danger: #ef4444;
      --color-success: #10b981;
      --border-radius: 8px;
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    [data-theme="light"] {
      --color-bg: #ffffff;
      --color-surface: #f1f5f9;
      --color-text: #1e293b;
      --color-text-secondary: #64748b;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--color-bg);
      color: var(--color-text);
      line-height: 1.5;
      min-height: 100vh;
      transition: var(--transition);
    }
    .app-container {
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: 100vh;
    }
    .sidebar {
      background-color: var(--color-surface);
      border-right: 1px solid rgba(255,255,255,0.1);
      padding: 1.5rem;
      position: sticky;
      top: 0;
      height: 100vh;
    }
    .main-content { padding: 2rem; }
    .card {
      background: var(--color-surface);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: var(--transition);
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--color-primary);
      color: white;
      border: none;
      padding: 0.75rem 1.25rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
    }
    .btn:hover {
      background: var(--color-primary-dark);
      transform: translateY(-1px);
    }
    .webhook-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    .webhook-table th {
      text-align: left;
      padding: 1rem;
      background: var(--color-surface);
      position: sticky;
      top: 0;
    }
    .webhook-table td {
      padding: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .form-group { margin-bottom: 1.25rem; }
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--color-text-secondary);
    }
    .form-control {
      width: 100%;
      padding: 0.75rem;
      background: var(--color-bg);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--border-radius);
      color: var(--color-text);
      transition: var(--transition);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-in {
      animation: fadeIn 0.3s ease-out forwards;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2 style="display: flex; align-items: center; gap: 0.5rem;">
          <i class="ti ti-shield-lock"></i>
          <span>Webhook Secure</span>
        </h2>
      </div>
      <nav class="sidebar-nav">
        <ul style="list-style: none; margin-top: 2rem;">
          <li style="margin-bottom: 0.5rem;">
            <a href="#" class="sidebar-link" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; border-radius: var(--border-radius); color: var(--color-text); text-decoration: none;">
              <i class="ti ti-home"></i>
              <span>Dashboard</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>
    <!-- Main Content -->
    <main class="main-content">
      <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1>Webhook Management</h1>
        <div style="display: flex; gap: 1rem; align-items: center;">
          <button id="themeToggle" class="btn" style="background: transparent; border: 1px solid var(--color-primary);">
            <i class="ti ti-sun"></i>
          </button>
          <div class="user-avatar" style="width: 40px; height: 40px; border-radius: 50%; background: var(--color-primary); display: flex; align-items: center; justify-content: center; color: white;">
            <i class="ti ti-user"></i>
          </div>
          <!-- Tombol Logout -->
          <button class="btn" onclick="manager.logout()">
            <i class="ti ti-logout"></i>
            Logout
          </button>
        </div>
      </header>
      <!-- Stats Cards -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="card animate-in" style="animation-delay: 0.1s;">
          <h3 style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: 0.5rem;">Total Webhooks</h3>
          <p style="font-size: 1.5rem; font-weight: 600;" id="totalWebhooks">0</p>
        </div>
      </div>
      <!-- Chart Card -->
      <div class="card animate-in" style="animation-delay: 0.15s;">
        <h2 style="margin-bottom: 1rem;">Webhook Requests</h2>
        <canvas id="chartCanvas" style="max-width: 100%; max-height: 300px;"></canvas>
      </div>
      <!-- Webhook Creation Form -->
      <div class="card animate-in" style="animation-delay: 0.2s;">
        <h2 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
          <i class="ti ti-plus"></i>
          <span>Create New Webhook</span>
        </h2>
        <div class="form-group">
          <label class="form-label">Discord Webhook URL</label>
          <input type="text" class="form-control" id="webhookUrl" placeholder="https://discord.com/api/webhooks/...">
        </div>
        <button class="btn" onclick="manager.createWebhook()" style="margin-top: 1rem;">
          <i class="ti ti-link"></i>
          Generate Secure Link
        </button>
        <div id="result" style="margin-top: 1.5rem; font-size: 1rem;"></div>
      </div>
      <!-- Webhook Deleter Section -->
      <div class="card animate-in" style="animation-delay: 0.25s;">
        <h2 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
          <i class="ti ti-trash"></i>
          <span>Webhook Deleter</span>
        </h2>
        <div class="form-group">
          <label class="form-label">Webhook URL to Delete (Discord & DB)</label>
          <input type="text" class="form-control" id="deleteWebhookUrl" placeholder="Enter webhook URL to delete">
        </div>
        <button class="btn" onclick="manager.deleteWebhook()" style="margin-top: 1rem;">
          <i class="ti ti-trash"></i>
          Delete Webhook
        </button>
        <div id="deleteResult" style="margin-top: 1.5rem; font-size: 1rem;"></div>
      </div>
      <!-- Webhook Table -->
      <div class="card animate-in" style="animation-delay: 0.3s;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h2 style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="ti ti-list"></i>
            <span>Webhook History</span>
          </h2>
        </div>
        <div style="overflow-x: auto;">
          <table class="webhook-table">
            <thead>
              <tr>
                <th>Secure Link</th>
                <th>Original URL</th>
                <th>Note</th>
                <th>Created By</th>
                <th>Created At</th>
                <th>Requests</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="statsBody">
              <!-- Data akan dimuat di sini -->
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    class WebhookManager {
      constructor() {
        this.authToken = localStorage.getItem('token') || '';
        this.currentUser = null;
        this.chartInstance = null;
        this.init();
      }
      async init() {
        this.loadTheme();
        this.setupEventListeners();
        if (!this.authToken) {
          alert('Please login first!');
          window.location.href = '/login.html';
          return;
        }
        await this.loadStats();
        await this.loadChartData();
      }
      loadTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        this.updateThemeIcon(savedTheme);
      }
      updateThemeIcon(theme) {
        const icon = document.querySelector('#themeToggle i');
        icon.className = theme === 'dark' ? 'ti ti-sun' : 'ti ti-moon';
      }
      toggleTheme() {
        const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        this.updateThemeIcon(newTheme);
      }
      logout() {
        localStorage.removeItem('token');
        alert('Logged out!');
        window.location.href = '/login.html';
      }
      async createWebhook() {
        const url = document.getElementById('webhookUrl').value;
        const resultEl = document.getElementById('result');
        resultEl.textContent = 'Processing...';
        if (!url) {
          resultEl.textContent = 'Please enter a webhook URL';
          return;
        }
        try {
          const response = await fetch('/webhooks', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + this.authToken
            },
            body: JSON.stringify({ url })
          });
          const data = await response.json();
          if (data.success) {
            resultEl.innerHTML = `<strong>Secure Link:</strong> ${data.secured_url}`;
            await this.loadStats();
            await this.loadChartData();
          } else {
            resultEl.textContent = 'Error: ' + (data.error || data.message);
          }
        } catch (err) {
          console.error(err);
          resultEl.textContent = 'Failed to create webhook';
        }
      }
      async deleteWebhook() {
        const url = document.getElementById('deleteWebhookUrl').value;
        const resultEl = document.getElementById('deleteResult');
        resultEl.textContent = 'Deleting from Discord & DB...';
        if (!url) {
          resultEl.textContent = 'Please enter a webhook URL';
          return;
        }
        try {
          const response = await fetch('/webhooks', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + this.authToken
            },
            body: JSON.stringify({ url })
          });
          const data = await response.json();
          if (response.ok) {
            resultEl.innerHTML = `<strong>Success:</strong> ${data.message}`;
            await this.loadStats();
            await this.loadChartData();
          } else {
            resultEl.textContent = `Error: ${data.error || data.message}`;
          }
        } catch (err) {
          console.error(err);
          resultEl.textContent = 'Failed to delete webhook from Discord/DB';
        }
      }
      async editWebhook(oldId, oldUrl, oldNote) {
        const newUrl = prompt('Enter new Original URL (leave blank if no change):', oldUrl);
        if (newUrl === null) return;
        const newId = prompt('Enter new Secure Link ID (leave blank if no change):', oldId);
        if (newId === null) return;
        const newNote = prompt('Enter new note (leave blank if no change):', oldNote || '');
        if (newNote === null) return;
        try {
          const body = {};
          if (newUrl && newUrl !== oldUrl) body.newUrl = newUrl;
          if (newId && newId !== oldId) body.newId = newId;
          if (newNote !== oldNote) body.newNote = newNote;
          if (!Object.keys(body).length) {
            alert('No changes provided.');
            return;
          }
          const res = await fetch(`/webhooks/${oldId}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + this.authToken
            },
            body: JSON.stringify(body)
          });
          const data = await res.json();
          if (res.ok) {
            alert('Edit success: ' + data.message);
            await this.loadStats();
            await this.loadChartData();
          } else {
            alert('Edit failed: ' + (data.error || 'Unknown error'));
          }
        } catch (err) {
          console.error(err);
          alert('Server error on edit');
        }
      }
      async loadStats() {
        try {
          const response = await fetch('/stats', {
            headers: { 'Authorization': 'Bearer ' + this.authToken }
          });
          const data = await response.json();
          if (data.success) {
            document.getElementById('totalWebhooks').textContent = data.webhooks.length;
            const tbody = document.getElementById('statsBody');
            tbody.innerHTML = data.webhooks.map(wh => `
              <tr>
                <td>
                  <div class="secured-link" style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="text" value="${wh.secured_url}" readonly style="flex: 1; padding: 0.5rem; background: var(--color-bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--color-text);">
                    <button onclick="navigator.clipboard.writeText('${wh.secured_url}')" style="background: transparent; border: none; color: var(--color-primary); cursor: pointer;">
                      <i class="ti ti-copy"></i>
                    </button>
                  </div>
                </td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${wh.original_url}">
                  ${wh.original_url}
                </td>
                <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${wh.note || ''}">
                  ${wh.note || ''}
                </td>
                <td>${wh.creator}</td>
                <td>${wh.created_at}</td>
                <td>${wh.request_count}</td>
                <td>
                  <div style="display: flex; gap: 0.5rem;">
                    <button style="background: transparent; border: none; color: var(--color-success); cursor: pointer;"
                      onclick="manager.editWebhook('${wh.id}', '${wh.original_url}', '${wh.note || ''}')"
                    >
                      <i class="ti ti-edit"></i>
                    </button>
                    <button style="background: transparent; border: none; color: var(--color-danger); cursor: pointer;"
                      onclick="manager.deleteWebhookFromTable('${wh.original_url}')"
                    >
                      <i class="ti ti-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `).join('');
          } else {
            alert('Error loading stats');
          }
        } catch (err) {
          console.error('Failed to load stats:', err);
        }
      }
      async loadChartData() {
        try {
          const res = await fetch('/chart-data', {
            headers: { 'Authorization': 'Bearer ' + this.authToken }
          });
          const data = await res.json();
          if (!data.success) {
            console.log('Chart data error:', data.error);
            return;
          }
          const { labels, data: chartData } = data;
          this.renderCharts(labels, chartData);
        } catch (err) {
          console.error('Chart data error:', err);
        }
      }
      renderCharts(labels = [], chartData = []) {
        const canvas = document.getElementById('chartCanvas');
        if (!canvas) return;
        if (this.chartInstance) {
          this.chartInstance.destroy();
        }
        this.chartInstance = new Chart(canvas, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Webhook Requests',
              data: chartData,
              borderColor: 'rgba(62, 142, 247, 1)',
              backgroundColor: 'rgba(62, 142, 247, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { position: 'top' } }
          }
        });
      }
      async deleteWebhookFromTable(url) {
        if (!confirm('Are you sure to delete this webhook from DB & Discord?')) return;
        const deleteResultEl = document.getElementById('deleteResult');
        deleteResultEl.textContent = 'Deleting from DB & Discord...';
        try {
          const response = await fetch('/webhooks', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + this.authToken
            },
            body: JSON.stringify({ url })
          });
          const data = await response.json();
          if (response.ok) {
            deleteResultEl.innerHTML = `<strong>Success:</strong> ${data.message}`;
            await this.loadStats();
            await this.loadChartData();
          } else {
            deleteResultEl.textContent = `Error: ${data.error || data.message}`;
          }
        } catch (err) {
          console.error(err);
          deleteResultEl.textContent = 'Failed to delete webhook from DB/Discord';
        }
      }
      setupEventListeners() {
        document.getElementById('themeToggle').addEventListener('click', () => this.toggleTheme());
      }
    }
    window.manager = new WebhookManager();
  </script>
</body>
</html>
